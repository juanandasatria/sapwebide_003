/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/rsh/eam/lib/common/controller/BaseController","sap/ui/model/json/JSONModel","sap/rsh/eam/lib/common/formatters/formatter","sap/rsh/eam/lib/common/utils/utils","sap/rsh/eam/lib/common/utils/GanttUtils","sap/rsh/eam/lib/common/controller/OrderPopup","sap/rsh/eam/lib/common/controller/OperationPopup","sap/rsh/eam/lib/common/controller/FunctionalLocationPopup","sap/rsh/eam/lib/common/controller/EquipmentPopup","sap/rsh/eam/lib/common/utils/Constants","sap/rsh/eam/lib/common/utils/StatusCommon","sap/rsh/eam/lib/common/controller/AssignMyWorkCenters","sap/rsh/eam/lib/common/controller/ChangeOperations","sap/gantt/config/SettingItem","sap/rsh/eam/lib/common/utils/AppState","sap/rsh/eam/lib/common/utils/AppPersContainer","sap/rsh/eam/lib/common/utils/ItemHashMap","sap/gantt/def/cal/Calendar","sap/gantt/def/cal/CalendarDefs","sap/gantt/def/cal/TimeInterval","sap/gantt/simple/GanttPrinting","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/rsh/eam/lib/common/controller/GanttChartSettingsDialog","sap/gantt/simple/Relationship","sap/rsh/eam/lib/common/controller/RelationshipActionSheet","sap/ui/core/Fragment"],function(B,J,F,U,G,O,a,b,E,C,S,A,c,d,e,f,I,g,h,T,l,o,q,r,R,t,u){"use strict";return B.extend("rsh.eam.ordergantts1.controller.SchedulingBoard",{formatter:F,ganttUtils:G,DISPATCHED:30,DUE:20,INPROCESS:40,_sOrderAllTechMandatoryFields:"MaintenanceOrder,MaintenanceOrderDesc,MaintenanceOrderInternalID,OrderStartDateTime,OrderEndDateTime,ProcessingStatus,ProcessingStatusText,OrderOperationRowLevel,OrderOperationParentRowID,OrderOperationRowID,OrderOperationIsExpanded,MaintOrderRoutingNumber,LatestAcceptableCompletionDate,OrderType",_sOrderAppStateFields:"",_sOrderAdditionalPopOverFields:"FunctionalLocationName,FunctionalLocation,EquipmentName,Equipment,MaterialStatusKey,MaterialStatusText",_sOperationAllTechMandatoryFields:"MaintenanceOrder,MaintenanceOrderOperation,MaintenanceOrderSubOperation,MaintenanceOrderDesc,MainWorkCenter,MaintenanceOrderInternalID,MaintOrderOperationInternalID,OrderOperationStartDateTime,OrderOperationEndDateTime,ProcessingStatus,ProcessingStatusText,OrderOperationRowLevel,OrderOperationParentRowID,OrderOperationRowID,OrderOperationIsExpanded,WorkCenter,OperationHasLongText,HasError,OperationDescription,WorkCenterInternalID,HasCrossOrderRelationship,HasErrorDescription,ID,PlannedStartDate,PlannedStartTime,OperationPersonResponsible,OperationPersonRespName,MaintOrderRoutingNumber,MaintOrderOperationCounter,OpBscStartDateConstraintType,OrderOpStartConstraintDateTime,OpBscEndDateConstraintType,OrderOpEndConstraintDateTime,OrderType",_sOperationAppStateFields:"",_afilterFieldGroups:["MaintenanceNotification","WorkCenterInternalID","WorkCenterTypeCode","Plant","OperationControlKey","PlannedStartDate","PlannedEndDate","PlannedStartTime","PlannedEndTime","OperationDuration","OperationPlannedWork","NumberOfCapacities","OperationHasLongText","OperationPersonResponsible","OperationPersonRespName","HasError","MaintOpExecutionStageName","WorkCenter","PlantSection","MaintOpExecStageShortText"],_aExpandFields:["to_OrderActiveStatus","to_OrderDetails"],_sSelectString:null,sSortOrderField:"MaintenanceOrder",sSortOperationField:"MaintenanceOrderOperation",sOrderSortOrder:"Ascending",sOperationSortOrder:null,statusCommon:null,_bFirstTriggerDone:false,_sAfterStatusChangesFinalizedSourceApp:C.sAfterStatusChangesFinalizedGanttApp,_bPagingRequestOfSubnodes:false,_bNewColumnAdded:false,_sExistingFilterString:null,_sPerformanceFilterOnExpand:null,_isIAppState:null,sOrderGanttChannel:"rsh.eam.ordergantts",sIndiviudalActionOnGanttChange:"individualChangeOnGanttChange",onInit:function(){this._oOwnerComponent=this.getOwnerComponent();this._oOwnerComponent.setModel(new J({"rowCount":0,"showImpRel":false,"showExpRel":false,"showNonWorkingTimes":false,"showCriticalPath":false,"condensedModeActive":false,"showFinalDueDate":false}),"UIModel");this._bAdjustToolbar=false;this._oDataModel=this.getOwnerComponent().getModel();this._oDataModel.attachBatchRequestSent(this._requestSent,this);this._oDataModel.attachBatchRequestCompleted(this._requestComplete,this);this._setTimeAxis();this.initMessagePopover();this.attachModelErrorHandler("readModel");var i=this.getView().byId("idOrderTreeTable");var j=this.getView().byId("idOrderGanttChartWithTable");this._oAppStateData=f.getInstance().getFeatureModel(C.sGanttAppState).getData();if(this._oAppStateData.customData===undefined){this._oAppStateData={};this._oAppStateData.customData=G.oneTimeInitilzationOfAppState(i,j);}G.setGanttColumnPersonalization(this._oAppStateData,i,j,this);i.attachSort(this.onSortRequest,this);i.attachColumnResize(this._onPersChangeForColumns,this);i.attachColumnVisibility(this._onPersChangeForColumns,this);this.statusCommon=new S(this._sAfterStatusChangesFinalizedSourceApp);this._setupSettings();this.updateRelationshipsAndUtilizations();this._setCondensedMode();this._bActionInitiatedFromContextMenu=false;},_getCurrentTimePeriod:function(){var i;var j;if(this.getView().byId("idOrderGanttSmartFilterBar").isInitialised()&&this.getView().byId("idOrderGanttSmartFilterBar").getFilterData()&&(this.getView().byId("idOrderGanttSmartFilterBar").getFilterData().PeriodType.conditionTypeInfo.data.operation==="DATERANGE"||this.getView().byId("idOrderGanttSmartFilterBar").getFilterData().PeriodType.conditionTypeInfo.data.operation==="TODAYFROMTO")){if(U.isMockRun()){i=this.getView().byId("idOrderGanttSmartFilterBar").getFilterData().PeriodType.conditionTypeInfo.data.value1;}else{i=this.dateObjectCopy(this.getView().byId("idOrderGanttSmartFilterBar").getFilterData().PeriodType.ranges[0].value1);}j=this.dateObjectCopy(this.getView().byId("idOrderGanttSmartFilterBar").getFilterData().PeriodType.ranges[0].value2);j.setDate(j.getDate()+1);}else{i=new Date();j=new Date();var k=35-j.getDay();i.setDate(i.getDate()-7);j.setDate(j.getDate()+k);}i.setHours(0,0,0);j.setHours(0,0,0);this.oPeriodTypeDates={};this.oPeriodTypeDates.oStartDate=U.getAdjustedDate(i);this.oPeriodTypeDates.oEndDate=U.getAdjustedDate(j);var m={};m.sCalendarStartDate=i;m.sCalendarEndDate=j;m.sInitStartDate=this.getDatePerTimeAxisFormat(i);m.sInitEndDate=this.getDatePerTimeAxisFormat(j);return m;},_setTimeAxis:function(){var i=this._getCurrentTimePeriod();var z=new sap.gantt.axistime.ProportionZoomStrategy({totalHorizon:new sap.gantt.config.TimeHorizon({startTime:i.sInitStartDate,endTime:i.sInitEndDate}),visibleHorizon:new sap.gantt.config.TimeHorizon({startTime:i.sInitStartDate,endTime:i.sInitEndDate})});this.byId("idOrderGanttChartWithTable").setAxisTimeStrategy(z);},formatOrderOpsLink:function(i,m,j,k,n,p){if(i===0){return m+" "+j;}else{if(p){return k+" / "+p+" "+n;}else{return k+" "+n;}}},formatWork:function(D,s){if(D&&s){return this.formatter.formatDuration(D)+" "+s;}else{return"";}},getTitle:function(s,i){if(s!==null&&i!==null){return this._formatToLocale(this.removeTimeZoneOffset(s))+" - "+this._formatToLocale(this.removeTimeZoneOffset(i));}return"";},removeTimeZoneOffset:function(i){if(i){return new Date(i.getTime()+i.getTimezoneOffset()*60*1000);}else{return undefined;}},getRectangleHight:function(i,j){if(i===1&&j){return 12;}else if(i===1&&j===false){return 20;}else{return 0;}},getShevronHight:function(i,j){if(i===0&&j){return 12;}else if(i===0&&j===false){return 20;}else{return 0;}},getShevronHeadWidth:function(i){if(i){return 6;}else{return 10;}},getShevronTailWidth:function(i){if(i){return 6;}else{return 10;}},getCriticalPathHight:function(i,j){if(i===1&&j){return 1;}else if(i===1&&j===false){return 2;}else{return 0;}},getCPyBiasValue:function(i,j){if(i===1&&j){return 8;}else if(i===1&&j===false){return 15;}else{return 0;}},constraintTimeFormatter:function(i,s){if(s==="1"){return this.removeTimeZoneOffset(i);}else{return null;}},getStartConstraintTypeText:function(s,i){var j=this.getView().getModel("i18n").getResourceBundle();if(i){var k=sap.ui.core.format.DateFormat.getDateInstance().format(i,true);var m=sap.ui.core.format.DateFormat.getTimeInstance().format(i,true);}switch(s){case"1":return j.getText("bscStartDateConstraintType1Tooltip",[k,m]);case"2":return j.getText("bscStartDateConstraintType2Tooltip",[k,m]);case"3":return j.getText("bscStartDateConstraintType3Tooltip",[k,m]);case"4":return j.getText("bscStartDateConstraintType4Tooltip");default:return"";}},getFinishConstraintTypeText:function(s,i){var j=this.getView().getModel("i18n").getResourceBundle();if(i){var k=sap.ui.core.format.DateFormat.getDateTimeInstance().format(i,true);var m=sap.ui.core.format.DateFormat.getTimeInstance().format(i,true);}switch(s){case"1":return j.getText("bscEndDateConstraintType1Tooltip",[k,m]);case"2":return j.getText("bscEndDateConstraintType2Tooltip",[k,m]);case"3":return j.getText("bscEndDateConstraintType3Tooltip",[k,m]);case"4":return j.getText("bscEndDateConstraintType4Tooltip");default:return"";}},getOpConstraintFill:function(s,i,j){switch(s){case"1":if(JSON.stringify(i)===JSON.stringify(j)){return"@sapTextColor";}else{return"@sapNegativeColor";}case"2":if(i<j){return"@sapTextColor";}else{return"@sapNegativeColor";}case"3":if(i>j){return"@sapTextColor";}else{return"@sapNegativeColor";}case"4":return"@sapTextColor";default:return"@sapTextColor";}},_formatToLocale:function(D){if(!this._oDateFormatter){this._oDateFormatter=sap.ui.core.format.DateFormat.getDateTimeInstance({locale:sap.ui.getCore().getConfiguration().getLocale()});}if(D){return this._oDateFormatter.format(D);}else{return D;}},getColor:function(p){switch(p){case this.DISPATCHED:return"@sapPositiveColor";case this.DUE:return"@sapCriticalColor";default:return"@sapNeutralColor";}},formatActivityType:function(i,j){if(i&&j){return j+" ("+i+")";}else{return undefined;}},isDNDPossible:function(s,p){if(s===""&&p!==C.inProcessCode){return true;}else{return false;}},isConnectable:function(s,i,j,p){if((s||i)&&j===""&&p!==C.inProcessCode){return true;}else{return false;}},onAfterRendering:function(){if(!this._bAdjustToolbar){var _=this.getView().byId("idOrderGanttContainer");var i=this.byId("idCustomGanttSettingBtn");var j=_.getToolbar();j.removeContent(i);j.insertContent(i,j.getContent().length);j.removeContent(j.oToolbarSpacer);j.oToolbarSpacer=null;this._bAdjustToolbar=true;}},_initBindingEventHandlers:function(){var i=this.getView().byId("idOrderTreeTable").getBinding("rows");this.getView().byId("idOrderTreeTable").attachToggleOpenState(this._onExpandRow,this);i.attachEvent("dataReceived",function(j){var k=i.oLengths.null;var m=this.getOwnerComponent().getModel("UIModel");m.setProperty("/rowCount",k);var n=false;if(j.getParameters().data){var p=j.getParameters().data.results.length;var s=j.getParameters().data.__count;if(p<s){this._bPagingRequestOfSubnodes=true;}else{this._bPagingRequestOfSubnodes=false;if(j.getParameters().data&&j.getParameters().data.results.length){if(j.getParameters().data.results[0].OrderOperationRowLevel===1){this.setFinalSelectForOrderRequest(n);}}}}}.bind(this));i.attachChange(this._onChange,this);},_onExpandRow:function(i){if(i.getParameters().expanded===true){var m=i.getParameters().rowContext.getProperty().MaintenanceOrder;var M=[];M.push(m);this._addPerformanceFilterOnExpand(M);}},_addPerformanceFilterOnExpand:function(m){var j=this.getView().byId("idOrderTreeTable");var k=j.getBinding("rows");var M=null;this._sExistingFilterString=k.sFilterParams;if(this._sPerformanceFilterOnExpand){this._sExistingFilterString=this._sExistingFilterString.substr(this._sPerformanceFilterOnExpand.length);}for(var i=0;i<m.length;i++){if(m.length===1){M="MaintenanceOrder eq '"+m[i]+"' and ";M=encodeURIComponent(M);k.sFilterParams=M+this._sExistingFilterString;this._sPerformanceFilterOnExpand=M;}else if(i===0){M="("+"MaintenanceOrder eq '"+m[i]+"' or ";}else if(i===(m.length-1)){M=M+"MaintenanceOrder eq '"+m[i]+"')";}else{M=M+"MaintenanceOrder eq '"+m[i]+"' or ";}}if(m.length!==1){M=encodeURIComponent(M);k.sFilterParams=M+"%20and%20"+this._sExistingFilterString;this._sPerformanceFilterOnExpand=M+"%20and%20";}},_determineVisibleColumnsFromAppState:function(n,p,M){var s=null;var v=[];var w=this.getView().byId("idOrderTreeTable");if(p){s=this._oAppStateData.customData;v=s.aVisibleColumns;}else{var x=w.getColumns();for(var m=0;m<x.length;m++){if(x[m].getVisible()){v.push({"pos":m,"width":x[m].getWidth(),"columnBindingName":x[m].getSortProperty()});}}}var y;var z=false;for(var k=0;k<v.length;k++){if(v[k].columnBindingName===M){z=true;break;}}if(M&&!z){y={pos:25,width:"20%",columnBindingName:M};v[v.length]=y;}if(n){this._sOrderAppStateFields="";for(var i=0;i<v.length;i++){switch(v[i].columnBindingName){case"MaintenanceOrder":break;case"MaintPriority":this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"MaintPriorityDesc";break;case"MaintenanceActivityType":this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"MaintenanceActivityTypeName";break;case"FunctionalLocationName":this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"FunctionalLocation";break;case"EquipmentName":this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"Equipment";break;case"TechnicalObjectDescription":this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"TechnicalObjectLabel";if(this._sOrderAppStateFields.indexOf("TechObjIsEquipOrFuncnlLoc")===-1){this._sOrderAppStateFields=this._sOrderAppStateFields+","+"TechObjIsEquipOrFuncnlLocDesc,TechObjIsEquipOrFuncnlLoc";}break;case"TechObjIsEquipOrFuncnlLocDesc":if(this._sOrderAppStateFields.indexOf("TechObjIsEquipOrFuncnlLoc")===-1){this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"TechObjIsEquipOrFuncnlLoc";}break;case"MaterialStatusText":this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"MaterialStatus";break;case"OperationDuration":break;case"OperationPlannedWork":break;case"OperationControlKey":break;case"PlannedStartDate":break;case"PlannedEndDate":break;case"PlannedStartTime":break;case"PlannedEndTime":break;case"MaintOpExecutionStageName":break;case"MaintOpExecStageShortText":break;case"OperationPersonResponsible":break;case"OperationPersonRespName":break;case"NumberOfCapacities":break;case"MaintOrdProcessPhaseCode":this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"MaintOrdProcessPhaseDesc";break;case"MaintOrdProcessSubPhaseCode":this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName+","+"MaintOrdProcessSubPhaseDesc";break;case"ProcessingStatus":break;case"OperationHasLongText":break;case"HasError":break;default:this._sOrderAppStateFields=this._sOrderAppStateFields+","+v[i].columnBindingName;break;}if(this._sOrderAppStateFields.startsWith(",",0)){this._sOrderAppStateFields=this._sOrderAppStateFields.substring(1);}}}else{this._sOperationAppStateFields="";for(var j=0;j<v.length;j++){switch(v[j].columnBindingName){case"MainWorkCenter":break;case"MaintOrdProcessPhaseCode":this._sOperationAppStateFields=this._sOperationAppStateFields+","+"MaintOrdOpProcessPhaseCode"+","+"MaintOrdOpProcessPhaseDesc";break;case"MaintOrdProcessSubPhaseCode":this._sOperationAppStateFields=this._sOperationAppStateFields+","+"MaintOrdOpProcessSubPhaseCode"+","+"MaintOrdOpProcessSubPhaseDesc";break;case"MaintenanceOrder":break;case"ProcessingStatus":break;case"MaintPriority":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"MaintPriorityDesc";break;case"OrderSystemConditionText":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"OperationSystemCondition,OperationSystemConditionText";break;case"MaintenanceActivityType":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"MaintenanceActivityTypeName";break;case"FunctionalLocationName":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"FunctionalLocation,OperationFunctionalLocation,OpFunctionalLocationName";break;case"EquipmentName":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"Equipment,OperationEquipment,OperationEquipmentName";break;case"TechnicalObjectDescription":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"TechnicalObjectLabel,OperationTechnicalObjectLabel,OperationTechnicalObjectDesc";if(this._sOperationAppStateFields.indexOf("OpTechObjEquipOrFuncnlLoc")===-1){this._sOperationAppStateFields=this._sOperationAppStateFields+","+"TechObjIsEquipOrFuncnlLoc,TechObjIsEquipOrFuncnlLocDesc,OpTechObjEquipOrFuncnlLoc,OpTechObjEquipOrFuncnlLocDesc";}break;case"TechObjIsEquipOrFuncnlLocDesc":if(this._sOperationAppStateFields.indexOf("OpTechObjEquipOrFuncnlLoc")===-1){this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"TechObjIsEquipOrFuncnlLoc,OpTechObjEquipOrFuncnlLoc,OpTechObjEquipOrFuncnlLocDesc";}break;case"OperationDuration":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"OperationDurationUnit";break;case"OperationPlannedWork":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"OperationPlannedWorkUnit";break;case"MaterialStatusText":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"MaterialStatus";break;case"MaintOrdBasicStartDate":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"OrderStartDateTime";break;case"MaintOrdBasicEndDate":this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName+","+"OrderEndDateTime";break;default:this._sOperationAppStateFields=this._sOperationAppStateFields+","+v[j].columnBindingName;break;}}}},setFinalSelectForOperationRequest:function(){var i=false;var j=this._oOwnerComponent.getModel("UIModel");var k=this.getView().byId("idOrderTreeTable");var m=k.getBinding("rows");var n=false;var s="";var p="";this._determineVisibleColumnsFromAppState(i,n);this._sSelectString="$select="+this._sOperationAllTechMandatoryFields+this._sOperationAppStateFields;if(j.getProperty("/showImpRel")||j.getProperty("/showExpRel")){s="to_Relationships";p="&$expand=to_Relationships";}if(j.getProperty("/showUtilizationIndicator")){s=s?s+","+"to_UtilIndicator":"to_UtilIndicator";p=p?p+","+"to_UtilIndicator":"&$expand=to_UtilIndicator";}m.sCustomParams=s?this._sSelectString+","+s+p:this._sSelectString;},setFinalSelectForOrderRequest:function(i,m){var j=true;var k=this._oOwnerComponent.getModel("UIModel");var n=this.getView().byId("idOrderTreeTable");var p=n.getBinding("rows");var s="";var v="";this._determineVisibleColumnsFromAppState(j,i,m);if(this._sOrderAppStateFields){this._sSelectString="$select="+this._sOrderAllTechMandatoryFields+","+this._sOrderAppStateFields;}else{this._sSelectString="$select="+this._sOrderAllTechMandatoryFields;}if(k.getProperty("/showImpRel")||k.getProperty("/showExpRel")){s="to_Relationships";v="&$expand=to_Relationships";}if(k.getProperty("/showUtilizationIndicator")){s=s?s+","+"to_UtilIndicator":"to_UtilIndicator";v=v?v+","+"to_UtilIndicator":"&$expand=to_UtilIndicator";}p.sCustomParams=s?this._sSelectString+","+s+v:this._sSelectString;if(p.aSorters&&p.aSorters.length>=1&&p.aSorters[0].sPath===this.sSortOperationField){p.aSorters[0].sPath=this.sSortOrderField;p.aSorters[0].bDescending=this.sOrderSortOrder==="Descending"?true:false;}},_onChange:function(i){var j=i.getParameters();var k=this.getView().byId("idOrderTreeTable");var m=k.getBinding("rows");if(j&&j.reason==="expand"){this.setFinalSelectForOperationRequest();this._bPagingRequestOfSubnodes=true;if(k.getSortedColumns().length!==0){if(this._afilterFieldGroups.indexOf(k.getSortedColumns()[0].getSortProperty())!==-1||k.getSortedColumns()[0].getSortProperty()==="MainWorkCenter"||k.getSortedColumns()[0].getSortProperty()==="MaintOrdProcessPhaseCode"||k.getSortedColumns()[0].getSortProperty()==="MaintOrdProcessSubPhaseCode"||k.getSortedColumns()[0].getSortProperty()==="MaintenanceOrder"){m.aSorters[0].sPath=this.sSortOperationField;m.aSorters[0].bDescending=this.sOperationSortOrder==="Descending"?true:false;}}else if(m.aSorters.length!==0){if(m.aSorters[0].sPath==="MainWorkCenter"||m.aSorters[0].sPath==="MaintOrdProcessPhaseCode"||m.aSorters[0].sPath==="MaintOrdProcessSubPhaseCode"||m.aSorters[0].sPath==="MaintenanceOrder"){m.aSorters[0].sPath=this.sSortOperationField;m.aSorters[0].bDescending=this.sOperationSortOrder==="Descending"?true:false;}}}else if(j&&j.reason==="sort"){if(this._afilterFieldGroups.indexOf(this.sSortOperationField)!==-1||this.sSortOperationField==="WorkCenter"||this.sSortOperationField==="MaintenanceOrderOperation"||this.sSortOperationField==="OpFunctionalLocationName"||this.sSortOperationField==="OperationEquipmentName"||this.sSortOperationField==="OperationTechnicalObjectDesc"||this.sSortOperationField==="OperationSystemConditionText"||this.sSortOperationField==="MaintOrdOpProcessPhaseCode"||this.sSortOperationField==="MaintOrdOpProcessSubPhaseCode"){m.aSorters[0].sPath=this.sSortOperationField;m.aSorters[0].bDescending=this.sOperationSortOrder==="Descending";}this.setFinalSelectForOperationRequest();}sap.ui.getCore().getEventBus().publish(this.sOrderGanttChannel,this.sIndiviudalActionOnGanttChange,this);if(this._bActionInitiatedFromContextMenu===true){this.updateToolbarButtonsFromSelectedRows();this._bActionInitiatedFromContextMenu=false;}},setNavParamstoFilterBar:function(){var s=this._oOwnerComponent.getComponentData().startupParameters;var j={};var i=this.getView().byId("idOrderGanttSmartFilterBar");if(s){j=this.getGlobalFilter(s,j);}Object.keys(s).forEach(function(k,m){if(i.getControlByKey(k)){i.addFieldToAdvancedArea(k);}});i.setFilterData(j);i.getVariantManagement().currentVariantSetModified(true);},getGlobalFilter:function(s,j){var i=[];var p={};var k={};var w={};if(s.MaintPriority){p.key=s.MaintPriority[0];if(s.MaintPriorityDesc){p.text=s.MaintPriorityDesc[0];}else{p.text=p.key;}i.push(p);if(!j.MaintPriority){j.MaintPriority={};}j.MaintPriority.items=i;}i=[];if(s.ProcessingStatus){k.key=s.ProcessingStatus[0];i.push(k);if(!j.ProcessingStatus){j.ProcessingStatus={};}j.ProcessingStatus.items=i;}i=[];if(s.WorkCenter){w.key=s.WorkCenter[0];w.text=s.WorkCenter[0];i.push(w);if(!j.WorkCenter){j.WorkCenter={};}j.WorkCenter.items=i;}if(s.MaintenanceOrder){if(!j.MaintenanceOrder){j.MaintenanceOrder={};}j.MaintenanceOrder.items=[];var m=decodeURIComponent(s.MaintenanceOrder);var M=m.split(",");M.forEach(function x(v){j.MaintenanceOrder.items.push({"key":v,"text":v});});}if(s.PeriodType){var n=this.getPeriodTypeData(s,j);}return n;},getPeriodTypeData:function(s,j){var i={};var k={};k.data={};var m=new Date();var n=new Date();var p=new Date();var v=new Date();var w=[];v.setDate(v.getDate()-1);n.setDate(n.getDate()+28);n.setDate(n.getDate()-(n.getDay()+7)%7);p.setMonth(p.getMonth()-6);if(s.PeriodType){k.name="custom.oDateRange";k.data.calendarType="Gregorian";k.data.key="PeriodType";if(s.PeriodType[0]==="FUTURE"){k.data.operation="FISCALPERIOD0";i.Operations="BT";i.value1=m;i.value2=n;}else if(s.PeriodType[0]==="PAST"){k.data.operation="DATERANGE";k.data.value1=p;k.data.value2=v;i.Operations="BT";i.value1=p;i.value2=v;}else if(s.PeriodType[0]==="CUSTOM"){this._getCustomPeriodDate(s,m,n,k,i,"DATERANGE");}else if(s.PeriodType[0]==="CUSTOM_TODAYFROMTO"){this._getCustomPeriodDate(s,m,n,k,i,"TODAYFROMTO");}w.push(i);if(!j.PeriodType){j.PeriodType={};}j.PeriodType.ranges=w;j.PeriodType.conditionTypeInfo=k;}return j;},_getCustomPeriodDate:function(s,i,j,k,m,n){if(s.PeriodStartDate&&s.PeriodEndDate){if(n==="DATERANGE"){i=this.getValidDate(decodeURIComponent(s.PeriodStartDate[0]));j=this.getValidDate(decodeURIComponent(s.PeriodEndDate[0]));if(i&&j){k.data.operation=n;k.data.value1=i;k.data.value2=j;m.Operation="BT";m.value1=i;m.value2=j;m.exclude=false;m.keyField="PeriodType";}}else{k.data.operation=n;k.data.value1=s.PeriodStartDate[0];k.data.value2=s.PeriodEndDate[0];m.Operation="BT";m.value1=s.PeriodStartDate[0];m.value2=s.PeriodEndDate[0];m.exclude=false;m.keyField="PeriodType";}}},getValidDate:function(i){var D=new Date(i);if(D instanceof Date&&!isNaN(D)){return U.convertDateToGatewayString(D);}else{return null;}},_initTreeTableBinding:function(){var i=this.getView().byId("idOrderTreeTable");i.bindRows({path:"/C_RSHOrdersAndOperations",parameters:{treeAnnotationProperties:{hierarchyLevelFor:"OrderOperationRowLevel",hierarchyNodeFor:"OrderOperationRowID",hierarchyParentNodeFor:"OrderOperationParentRowID",hierarchyDrillStateFor:"OrderOperationIsExpanded"},gantt:{rowIdName:"OrderOperationRowID"},groupId:"iDBatchOrderFilterRequest"}});var j=true;this.setFinalSelectForOrderRequest(j);},formatStartTime:function(i){if(i){var D=this.removeTimeZoneOffset(i);D.setHours(0,0,0,0);return D;}return"";},getUtilizationColor:function(w){if(w>=0&&w<75){return"@sapUiShellPositiveColor";}if(w>=75&&w<=100){return"@sapUiShellCriticalColor";}if(w>100){return"@sapUiShellNegativeColor";}return"";},getTooltipForUtilization:function(w,W,s){return this.getView().getModel("i18n").getResourceBundle().getText("UtilizationTooltip",[Math.round(w),Math.round(parseFloat(W)),Math.round(parseFloat(s))]);},onInitSmartFilter:function(i){this._initTreeTableBinding();this._initBindingEventHandlers();var j=this.getView().byId("idOrderTreeTable").getBinding("rows");j.refresh();this.setNavParamstoFilterBar();},getAdditionalDateRangeFilterBlock:function(i){var j={};var p={};if(U.isMockRun()){return[];}var k=this.getView().byId("idOrderGanttSmartFilterBar").getFilterData();if(!k||(k&&!k.PeriodType)){p={oStartDate:new Date(),oEndDate:new Date()};p.oEndDate.setDate(p.oEndDate.getDate()+28);p.oEndDate.setDate(p.oEndDate.getDate()-(p.oEndDate.getDay()+7)%7);}else{p={oStartDate:this.dateObjectCopy(k.PeriodType.ranges[0].value1),oEndDate:this.dateObjectCopy(k.PeriodType.ranges[0].value2)};}if(i){return p;}var m=new sap.ui.model.Filter({path:"OpErlstSchedldExecStrtDte",value1:U.getAdjustedDate(p.oEndDate),operator:"LE"});var n=new sap.ui.model.Filter({path:"OpErlstSchedldExecEndDte",value1:U.getAdjustedDate(p.oStartDate),operator:"GE"});var L=new sap.ui.model.Filter({path:"OpLtstSchedldExecStrtDte",value1:U.getAdjustedDate(p.oEndDate),operator:"LE"});var s=new sap.ui.model.Filter({path:"OpLtstSchedldExecEndDte",value1:U.getAdjustedDate(p.oStartDate),operator:"GE"});var v=new sap.ui.model.Filter({path:"SchedulingIsPerformedBackward",value1:"X",operator:"EQ"});var w=new sap.ui.model.Filter({path:"SchedulingIsPerformedBackward",value1:" ",operator:"EQ"});var x=new sap.ui.model.Filter({path:"OpErlstSchedldExecEndDte",value1:U.getAdjustedDate(p.oEndDate),operator:"LE"});var y=new sap.ui.model.Filter({path:"OpLtstSchedldExecEndDte",value1:U.getAdjustedDate(p.oEndDate),operator:"LE"});var z=new sap.ui.model.Filter({filters:[m,n,w],and:true});var D=new sap.ui.model.Filter({filters:[L,s,v],and:true});var H=new sap.ui.model.Filter({filters:[x,n,w],and:true});var K=new sap.ui.model.Filter({filters:[y,s,v],and:true});if(!k||(k&&!k.PeriodType)){j=new sap.ui.model.Filter({filters:[z,D],and:false});}else{var M=k.PeriodType.conditionTypeInfo.data.operation;if(M==="FISCALPERIOD1"){j=new sap.ui.model.Filter({filters:[H,K],and:false});}else{j=new sap.ui.model.Filter({filters:[z,D],and:false});}}return j;},_setThresholdForModelData:function(){var i=this._getCurrentTimePeriod();var D=Math.abs(i.sCalendarEndDate-i.sCalendarStartDate);var j=Math.ceil(D/(1000*60*60*24));if(j>100){this._oOwnerComponent.getModel().setSizeLimit(j);}else if(this._oOwnerComponent.getModel().iSizeLimit>100){this._oOwnerComponent.getModel().setSizeLimit(100);}},onFilter:function(i){sap.ui.getCore().getMessageManager().removeAllMessages();this._setTimeAxis();if(U.isMockRun()){this.onInitSmartFilter();this._submitDelayedRequests();return;}if(!this._bFirstTriggerDone){if(i.getParameters()&&i.getParameters().hasOwnProperty("finalTrigger")){this.applyAndTriggerFinalFilter(i);}else{return;}}else{this.applyAndTriggerFinalFilter(i);}},applyAndTriggerFinalFilter:function(i){var s=this.getView().byId("idOrderGanttSmartFilterBar");var j=this.getView().byId("idOrderTreeTable");var k=j.getBinding("rows");var m=s.getFilters();var n={};n=this.getAdditionalDateRangeFilterBlock();var p=this._oOwnerComponent.getModel("UIModel");if(p.getProperty("/showUtilizationIndicator")||p.getProperty("/showNonWorkingTimes")){this._setThresholdForModelData();}if(k.aSorters.length>0){if(j.getSortedColumns().length!==0){if(this._afilterFieldGroups.indexOf(j.getSortedColumns()[0].getSortProperty())!==-1||j.getSortedColumns()[0].getSortProperty()==="WorkCenter"||j.getSortedColumns()[0].getSortProperty()==="MaintenanceOrderOperation"){this.sSortOperationField=j.getSortedColumns()[0].getSortProperty();this.sOperationSortOrder=j.getSortedColumns()[0].getSortOrder();}}k.aSorters[0].sPath=this.sSortOrderField;k.aSorters[0].bDescending=this.sOrderSortOrder==="Descending";}if(m&&m.length===1){var M=new sap.ui.model.Filter({filters:[m[0],n],and:true});var v=M.aFilters[0].aFilters;var w=0;for(;w<v.length;w++){if((v[w].sPath&&v[w].sPath==="PeriodType")||(v[w].aFilters&&v[w].aFilters[0].sPath==="PeriodType")){v.splice(w,1);break;}}if(v.length===0){M.aFilters.splice(0,1);}k.filter(M,sap.ui.model.FilterType.Application);}else{k.filter(n,sap.ui.model.FilterType.Application);}var x=false;this.setFinalSelectForOrderRequest(x);k.refresh();this.bindCalendarDefHelper();if(!this._bSubmitofDeferredRequestsDone){this._submitDelayedRequests();}this._sPerformanceFilterOnExpand=null;this.disableButtons();},onAssignedFiltersChanged:function(i){var s=this.getView().byId("idOrderGanttSmartFilterBar");var p=s.getControlByKey("PeriodType");if(p&&p.getValueState()===sap.ui.core.ValueState.Error){p.setValueStateText(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("timePeriodFilterError"));}var j=this.getView().byId("statusText");var k=i.getSource();if(j&&k){var m=k.retrieveFiltersWithValuesAsText();j.setText(m);}},onAfterVariantLoad:function(i){var s=i.getSource();var j=i.getParameters().context;if(j==="INIT"&&sap.ui.core.routing.HashChanger.getInstance().getCurrentNavigationState().oldHash.indexOf("WorkCenterUtilization-display")!==-1){s.clear();this.setNavParamstoFilterBar();var p={finalTrigger:true};if(s.isCurrentVariantExecuteOnSelectEnabled()===true){s.fireSearch(p);}}if((!j&&s.getControlByKey("PeriodType").getValue()==="")||(j==="RESET"&&s.isCurrentVariantStandard())){this.setDefaultDateRange();}},onSmartFilterInitialized:function(i){var s=i.getSource();if(s.getCurrentVariantId()===""&&s.getControlByKey("PeriodType").getValue()===""){this.setDefaultDateRange();}this._oAppStateInstance=e.getInstance();this._oAppStateInstance.retrieveAppState().then(function(j,k,n){if(n===sap.ui.generic.app.navigation.service.NavType.iAppState){this._isIAppState=true;this.setAppState(j);this._bIsAppStateApplied=true;this._delayedTriggerSearch();}else{this._isIAppState=false;this.setAppState(this._oAppStateData);this._bIsAppStateApplied=true;this._delayedTriggerSearch();}}.bind(this)).fail(function(){this._bIsAppStateApplied=true;this._delayedTriggerSearch();}.bind(this));},setDefaultDateRange:function(){var j={};var s=this.getView().byId("idOrderGanttSmartFilterBar");var p=s.getControlByKey("PeriodType");var i=new Date();var k=U.getEndDateNext();var m=i;var n=k;var v={};v.data={};j.PeriodType={};v.name="custom.oDateRange";v.data.calendarType="Gregorian";v.data.key="PeriodType";v.data.value1=m;v.data.value2=n;if(U.isMockRun()&&p.getSelectedKey()==="DATERANGE"){v.data.operation="DATERANGE";}else{v.data.operation="FISCALPERIOD0";}j.PeriodType.conditionTypeInfo=v;s.setFilterData(j);},dateObjectCopy:function(D){return new Date(JSON.parse(JSON.stringify(D)));},getDatePerTimeAxisFormat:function(D){var y=D.getFullYear().toString();var M=this.pad(D.getMonth()+1,2);var i=this.pad(D.getDate(),2);var j=this.pad(D.getHours(),2);var m=this.pad(D.getMinutes(),2);var s=this.pad(D.getSeconds(),2);return y+M+i+j+m+s;},pad:function(n,i){var s=""+n;while(s.length<i){s="0"+s;}return s;},onSortRequest:function(i,s){var j=this.getView().byId("idOrderTreeTable").getBinding("rows");var k=null;var m=null;var n=null;var _,p;if(s){k=this.getView().byId(s.id);m=s.sortProperty;n=s.sortOrder;}else{k=i.getParameters("bindingParams").column;m=k.getSortProperty();n=i.getParameters("bindingParams").sortOrder;this._onPersChangeForColumns(i);}if(this._afilterFieldGroups.indexOf(m)>=0){if(i){i.preventDefault();}this.sSortOperationField=m;this.sOperationSortOrder=n;_=new sap.ui.model.Sorter(this.sSortOrderField,this.sOrderSortOrder==="Descending");p=[_];this.updateColumnSortStatus(k,n);j.sort(p);}else{this.sSortOrderField=m;this.sOrderSortOrder=n;if(m==="MaintenanceOrder"){this.sSortOperationField="MaintenanceOrderOperation";this.sOperationSortOrder=n;}if(m==="ProcessingStatus"){this.sSortOperationField=this.sSortOrderField=m;this.sOperationSortOrder=this.sOrderSortOrder=n;}if(m==="FunctionalLocationName"){this.sSortOperationField="OpFunctionalLocationName";this.sSortOrderField=m;this.sOperationSortOrder=this.sOrderSortOrder=n;}if(m==="EquipmentName"){this.sSortOperationField="OperationEquipmentName";this.sSortOrderField=m;this.sOperationSortOrder=this.sOrderSortOrder=n;}if(m==="TechnicalObjectDescription"){this.sSortOperationField="OperationTechnicalObjectDesc";this.sSortOrderField=m;this.sOperationSortOrder=this.sOrderSortOrder=n;}if(m==="OrderSystemConditionText"){this.sSortOperationField="OperationSystemConditionText";this.sSortOrderField=m;this.sOperationSortOrder=this.sOrderSortOrder=n;}if(m==="MainWorkCenter"){this.sSortOperationField="WorkCenter";this.sOperationSortOrder=n;}if(m==="MaintOrdProcessPhaseCode"){this.sSortOperationField="MaintOrdOpProcessPhaseCode";this.sOperationSortOrder=n;}if(m==="MaintOrdProcessSubPhaseCode"){this.sSortOperationField="MaintOrdOpProcessSubPhaseCode";this.sOperationSortOrder=n;}}var v=false;if(j.sCustomParams!==this._sSelectString){this.setFinalSelectForOrderRequest(v);}if(s){_=new sap.ui.model.Sorter(this.sSortOrderField,this.sOrderSortOrder==="Descending");p=[_];this.updateColumnSortStatus(k,n);j.sort(p);}this._sPerformanceFilterOnExpand=null;},updateColumnSortStatus:function(s,i){var j=this.getView().byId("idOrderTreeTable").getColumns();j.forEach(function(k){if(k.getSorted){k.setSorted(false);k._updateIcons();}});s.setSorted(true);s.setSortOrder(i);s._updateIcons();},expandSelected:function(j){var k=this.getView().byId("idOrderTreeTable");var s=k.getSelectedIndices();var m=[];var n=this._getSelectedRowBindingContext(k);for(var i=0;i<n.length;i++){m.push(n[i].getProperty().MaintenanceOrder);}this._addPerformanceFilterOnExpand(m);k.expand(s);},collapseSelected:function(i){var j=this.getView().byId("idOrderTreeTable");var s=j.getSelectedIndices();j.collapse(s);},onColumnSelect:function(i){var j=i.getParameters().column;var k=j.getMenu();k.attachItemSelect(k,this._onItemInColumnMenuSelected,this);},_onItemInColumnMenuSelected:function(j,k){var s=j.getParameters().item.getText();var m;var n=j.getParameters().item.getIcon();var p=this.getView().byId("idOrderTreeTable");var v=p.getColumns();if(!n&&!j.getParameters().item.getSubmenu()){for(var i=0;i<v.length;i++){if(v[i].getLabel().getText()===s&&v[i].getVisible()){m=v[i].getSortProperty();break;}}var w=false;this.setFinalSelectForOrderRequest(w,m);this._bNewColumnAdded=true;this._sPerformanceFilterOnExpand=null;this._refreshBinding(true);}},onColumnVisibilityChanged:function(i){var s=i.getParameters().column;if(s.getIndex()===0){i.preventDefault();U.addMessage(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("CannotHideOrderColumn"),sap.ui.core.MessageType.Warning,C.sDisplayTypeMessageBox);}else if(s.getVisible()&&s.getSorted()){s.setSorted(false);var j=this.getView().byId("idOrderTreeTable").getBinding();j.aSorters=[];this.initSortOrderAndSortOperationFields();}},handleLinkPress:function(i){var j=i.getSource().getBindingContext().getProperty("OrderOperationRowLevel");if(j===0){this._oOrderPopupDelegate=new O();this.getView().getModel().setUseBatch(true);sap.ui.getCore().getMessageManager().registerObject(this._oOrderPopupDelegate.getFragment(),true);if(this._sOrderAppStateFields){this._oOrderPopupDelegate.setContentToFragment(i,this._oOwnerComponent,this._oOwnerComponent.getModel("readModel"),this._sOrderAllTechMandatoryFields+","+this._sOrderAppStateFields+","+this._sOrderAdditionalPopOverFields+","+this._aExpandFields.toString());}else{this._oOrderPopupDelegate.setContentToFragment(i,this._oOwnerComponent,this._oOwnerComponent.getModel("readModel"),this._sOrderAllTechMandatoryFields+","+this._sOrderAdditionalPopOverFields+","+this._aExpandFields.toString());}}else{this._oOperationPopupDelegate=new a();this.getView().getModel().setUseBatch(true);sap.ui.getCore().getMessageManager().registerObject(this._oOperationPopupDelegate.getFragment(),true);this._oOperationPopupDelegate.setContentToFragment(i,this._oOwnerComponent,this._oOwnerComponent.getModel("readModel"));}},handleFuncLocLinkPress:function(i,j){this._oInnerAppState={customData:this._getCurrentAppState()};this._oFunctionalLocationPopupDelegate=new b();this.getView().getModel().setUseBatch(true);sap.ui.getCore().getMessageManager().registerObject(this._oFunctionalLocationPopupDelegate.getFragment(),true);this._oFunctionalLocationPopupDelegate.setContentToFragment(i,this._oOwnerComponent,this._oOwnerComponent.getModel("readModel"),this._oInnerAppState,j);},handleEquipmentLinkPress:function(i,j){this._oInnerAppState={customData:this._getCurrentAppState()};this._oEquipmentPopupDelegate=new E();this.getView().getModel().setUseBatch(true);sap.ui.getCore().getMessageManager().registerObject(this._oEquipmentPopupDelegate.getFragment(),true);this._oEquipmentPopupDelegate.setContentToFragment(i,this._oOwnerComponent,this._oOwnerComponent.getModel("readModel"),this._oInnerAppState,j);},handleTechnicalObjectLinkPress:function(i){var s=i.getSource().getBindingContext().getProperty("TechObjIsEquipOrFuncnlLoc");var j=true;if(s==="EAMS_EQUI"){this.handleEquipmentLinkPress(i,j);}else{this.handleFuncLocLinkPress(i,j);}},openFilter:function(){this._oDelegate=new A();var i=this.getView().getModel("i18n");this._oDelegate.getFragment().setModel(i,"i18n");this.getView().getModel().setUseBatch(true);sap.ui.getCore().getMessageManager().registerObject(this._oDelegate.getFragment(),true);this._oDelegate.getFragment().setModel(this.getView().getModel());this.getView().getModel().setRefreshAfterChange(false);this._oDelegate.getFragment().setContentWidth("41%");this._oDelegate.getFragment().setBusy(true);this._oDelegate.getFragment().open();if(this._oMessageHandlerResponseModel){var m=this._oMessageHandlerResponseModel;m.setProperty("/bIsDialogOpen",true);this._oDelegate.getFragment().attachAfterClose(function(){m.setProperty("/bIsDialogOpen",false);});}},selectTableRows:function(j){var k=this.getView().byId("idOrderTreeTable");var m=j.getParameter("rowIndices");for(var i=0;i<m.length;i++){var p=decodeURIComponent(k.getContextByIndex(m[i]).sPath);if(p){var s=p;if(p.substring(0,1)==="/"){s=p.substring(1);}var M=this._getMessagesFromTarget(s);sap.ui.getCore().getMessageManager().removeMessages(M);}}this.updateToolbarButtonsFromSelectedRows();},updateToolbarButtonsFromSelectedRows:function(){var D=this.getView().byId("idButtonDispatch");var j=this.getView().byId("idButtonCancDispatch");var k=this.getView().byId("idButtonChange");var m=this.getView().byId("idRemoveConstraints");var s=this.getView().byId("idScheduleOrder");var n=this.getView().byId("idOrderTreeTable");var p=n.getSelectedIndices();if(!p||p.length===0||p[0].length===0){D.setEnabled(false);j.setEnabled(false);k.setEnabled(false);m.setEnabled(false);s.setEnabled(false);return;}var v=this._getSelectedRowBindingContext(n);var w=false;var x=false;var y=false;var z=false;var H=false;for(var i=0;i<v.length;i++){var K=v[i].getObject();if(K.OrderOperationRowLevel===0){x=true;}else if(U.checkIfOperationIsWithinTimePeriod(K,this.oPeriodTypeDates)){continue;}else{if(K.HasError){this.operationValidation(K);}else{z=true;switch(K.ProcessingStatus){case C.dispatchedStatusCode:y=true;break;case C.dueStatusCode:H=true;break;}if(K.OpBscStartDateConstraintType&&K.OrderOperationStartDateTime){w=true;}}}}if(x&&!z){D.setEnabled(false);j.setEnabled(false);k.setEnabled(false);m.setEnabled(false);s.setEnabled(true);}else{k.setEnabled(z);j.setEnabled(y);D.setEnabled(H);m.setEnabled(w);s.setEnabled(x);}},_getMessagesFromTarget:function(s){var m=sap.ui.getCore().getMessageManager().getMessageModel().getProperty("/");var M=[];m.forEach(function(i){if(i.target===s){M.push(i);}});return M;},operationValidation:function(i){var j=i.HasError;var s=i.ProcessingStatus;var m=i.MaintenanceOrder;var k=i.MaintenanceOrderOperation;var n=i.MaintenanceOrderSubOperation;var p="C_RSHOrdersAndOperations"+"("+"'"+i.ID+"'"+")";var v=this.getView().getModel("i18n").getResourceBundle();if(j&&s===C.inProcessCode){if(n){U.addMessage(v.getText("ErrorMessageInProcessStatusSubOper",[m,k,n]),sap.ui.core.MessageType.Information,C.sDisplayTypeMessagePopover,p,true);}else{U.addMessage(v.getText("ErrorMessageInProcessStatusOper",[m,k,null]),sap.ui.core.MessageType.Information,C.sDisplayTypeMessagePopover,p,true);}}},pressScheduleOrderButton:function(){var j=sap.ui.getCore().getEventBus();j.subscribeOnce(C.sLibraryChannel,C.sServerMessageToUpdateEntity,this.prepareTargetForRefreshGantt,this);var k=this.getView().byId("idOrderGanttContainer");var m=this.getView().byId("idOrderTreeTable");var s=this._getSelectedRowBindingContext(m);var n=this.getView().getModel("i18n").getResourceBundle();var p=false;var v;for(var i=0;i<s.length;i++){var w=s[i].getObject();if(w.OrderOperationRowLevel===0){if(p===true){U.addMessage(n.getText("SelectOnlyOneOrder"),sap.ui.core.MessageType.Error,C.sDisplayTypeMessageBox);return;}else{p=true;v=w;}}}if(v.OrderOperationRowLevel!==0||v.ProcessingStatus===C.inProcessCode){U.addMessage(n.getText("InProcessOrderSch"),sap.ui.core.MessageType.Error,C.sDisplayTypeMessageBox);return;}k.setBusy(true);var x="/ScheduleMaintenanceOrder";var y=this.getView().getModel("relationshipModel");var z={MaintenanceOrder:v.MaintenanceOrder};var D=this;y.callFunction(x,{method:"POST",urlParameters:z,success:function(H){D.onScheduleSuccess(v);},error:function(H){D.onScheduleFailed(v);}});},onScheduleSuccess:function(D){var i={};i.itemHashMapContainer=[];i.itemHashMapContainer.push(D.MaintenanceOrder);i.parameters={};i.parameters.bRefreshOfSourceAppRequired=true;var j=this.getView().getModel("i18n").getResourceBundle();U.addMessage(j.getText("ScheduleSuccess"),sap.ui.core.MessageType.Success,C.sDisplayTypeMessageToast);this.prepareTargetForRefreshGantt("","",i);this.getView().byId("idOrderGanttContainer").setBusy(false);},onScheduleFailed:function(i){var j=this.getView().getModel("i18n").getResourceBundle();U.addMessage(j.getText("ScheduleError"),sap.ui.core.MessageType.Error,C.sDisplayTypeMessagePopover);this.getView().byId("idOrderGanttContainer").setBusy(false);},pressDispatchButton:function(j){var k=sap.ui.getCore().getEventBus();k.subscribeOnce(C.sLibraryChannel,C.sServerMessageToUpdateEntity,this.prepareTargetForRefreshGantt,this);var m=this.getView().byId("idOrderGanttContainer");var v=this.getView().getModel();var n=this.getView().byId("idOrderTreeTable");var s=this._getSelectedRowBindingContext(n);m.setBusy(true);var p=null;var w=false;if(j.getSource().getId().includes("idButtonDispatchAction")){this._bActionInitiatedFromContextMenu=true;var x=this._oShapeForOpContextMenu.getBindingContext().getPath();var y=this.getModel().getData(x);p=y;if(!p.HasError){sap.ui.getCore().getMessageManager().removeAllMessages();this.statusCommon.setOperationDispatchStatus(p,v,w);}else{this.operationValidation(p);}}else{for(var i=0;i<s.length;i++){p=s[i].getObject();if(p.OrderOperationRowLevel===0||p.ProcessingStatus===C.dispatchedStatusCode){continue;}if(U.checkIfOperationIsWithinTimePeriod(p,this.oPeriodTypeDates)){continue;}if(!p.HasError){sap.ui.getCore().getMessageManager().removeAllMessages();this.statusCommon.setOperationDispatchStatus(p,v,w);}else{this.operationValidation(p);}}}this.statusCommon.triggerBackendCall();},pressCancDispatchButton:function(j){var k=sap.ui.getCore().getEventBus();k.subscribeOnce(C.sLibraryChannel,C.sServerMessageToUpdateEntity,this.prepareTargetForRefreshGantt,this);var v=this.getView().getModel();var m=this.getView().byId("idOrderGanttContainer");var n=this.getView().byId("idOrderTreeTable");var s=this._getSelectedRowBindingContext(n);m.setBusy(true);var p=null;var w=false;if(j.getSource().getId().includes("idButtonCancDispatchAction")){this._bActionInitiatedFromContextMenu=true;var x=this._oShapeForOpContextMenu.getBindingContext().getPath();var y=this.getModel().getData(x);p=y;if(!p.HasError){sap.ui.getCore().getMessageManager().removeAllMessages();this.statusCommon.cancelOperationDispatchStatus(p,v,w);}else{this.operationValidation(p);}}else{for(var i=0;i<s.length;i++){p=s[i].getObject();if(p.OrderOperationRowLevel===0||p.ProcessingStatus===C.dueStatusCode){continue;}if(U.checkIfOperationIsWithinTimePeriod(p,this.oPeriodTypeDates)){continue;}if(!p.HasError){sap.ui.getCore().getMessageManager().removeAllMessages();this.statusCommon.cancelOperationDispatchStatus(p,v,w);}else{this.operationValidation(p);}}}this.statusCommon.triggerBackendCall();},pressChangeOperationsButton:function(i){var j=sap.ui.getCore().getEventBus();if(i.getSource().getId().includes("idButtonChangeAction")){this._bActionInitiatedFromContextMenu=true;}j.subscribeOnce(C.sLibraryChannel,C.sServerMessageToUpdateEntity,this.prepareTargetForRefreshGantt,this);this._oChangeOperationsDelegate=new c();this.getView().getModel().setUseBatch(true);sap.ui.getCore().getMessageManager().registerObject(this._oChangeOperationsDelegate.getFragment(),true);this._oChangeOperationsDelegate.setContentToFragment(i,this._oOwnerComponent,this.getView(),this.statusCommon,this.oPeriodTypeDates,this._oShapeForOpContextMenu);},pressRemoveConstraintsButton:function(j){var k=sap.ui.getCore().getEventBus();k.subscribeOnce(C.sLibraryChannel,C.sServerMessageToUpdateEntity,this.prepareTargetForRefreshGantt,this);var v=this.getView().getModel();var m=this.getView().byId("idOrderGanttContainer");var n=this.getView().byId("idOrderTreeTable");var s=this._getSelectedRowBindingContext(n);m.setBusy(true);var p=null;if(j.getSource().getId().includes("idButtonRemoveConstraintsAction")){this._bActionInitiatedFromContextMenu=true;var w=this._oShapeForOpContextMenu.getBindingContext().getPath();var x=this.getModel().getData(w);p=x;if(!p.HasError){sap.ui.getCore().getMessageManager().removeAllMessages();this.statusCommon.removeOperationConstraints(p,v);}else{this.operationValidation(p);}}else{for(var i=0;i<s.length;i++){p=s[i].getObject();if(U.checkIfOperationIsWithinTimePeriod(p,this.oPeriodTypeDates)){continue;}if(!p.HasError){sap.ui.getCore().getMessageManager().removeAllMessages();this.statusCommon.removeOperationConstraints(p,v);}else{this.operationValidation(p);}}}this.statusCommon.triggerBackendCall();},_getSelectedRowBindingContext:function(j){var s=[];var k=j.getSelectedIndices();var m=j.getBinding("rows");for(var i=0;i<k.length;i++){if(m.getContextByIndex(k[i])){s.push(m.getContextByIndex(k[i]));}}return s;},_requestSent:function(i){this.requestProcessingHandler(this.onBeforeRequestCompleted,this.getView().byId("idOrderGanttContainer"),i);},_requestComplete:function(i){if(i.getParameter("requests")){var j=i.getParameter("requests")[0];if(j.url.indexOf("C_RSHEAMUserVariant")!==-1&&j.method!=="GET"){var k=this.getView().byId("idOrderTreeTable");var m=k.getBinding("rows");if(m.aSorters.length!==0){m.aSorters[0].sPath=this.sSortOrderField;m.aSorters[0].bDescending=this.sOrderSortOrder==="Descending";}}else if(j.url.indexOf("C_RSHOrdersAndOperations")!==-1&&j.method==="GET"){var n=this.getView().getModel("i18n").getResourceBundle();if(this._bNewColumnAdded){U.addMessage(n.getText("FullRefreshAfterColumnAdded"),sap.ui.core.MessageType.Information,C.sDisplayTypeMessageToast);this._bNewColumnAdded=false;}}}if(i.getParameter("requests")&&(j.url.indexOf("I_MaintOrderOperationTP")===-1&&j.method!=="POST")){this.requestProcessingHandler(this.onAfterRequestCompleted,this.getView().byId("idOrderGanttContainer"),i);if(this.onAfterDataRecievedFn){this.onAfterDataRecievedFn();this.onAfterDataRecievedFn=null;}}},onBeforeRequestCompleted:function(i){i.setBusy(true);},onAfterRequestCompleted:function(i){i.setBusy(false);},requestProcessingHandler:function(H,j,k){if(j){var m=k.getParameter("requests");var p=false;for(var i=0;m&&i<m.length;i++){p=m[i].url.indexOf("C_RSHOrdersAndOperations")!==-1;if(p){H(j);return;}}}},_onAfterActionsCompleted:function(i){if(i&&i.bRefreshOfSourceAppRequired){if(this._bActionInitiatedFromContextMenu){this.onAfterDataRecievedFn=i.onAfterTableBindFn;}else{this.disableButtons();this.getView().byId("idOrderTreeTable").getBinding("rows").clearSelection();this.onAfterDataRecievedFn=i.onAfterTableBindFn;}}else{this.getView().byId("idOrderGanttContainer").setBusy(false);if(i&&i.onAfterTableBindFn){i.onAfterTableBindFn();}}},disableButtons:function(){var D=this.getView().byId("idButtonDispatch");var i=this.getView().byId("idButtonCancDispatch");var j=this.getView().byId("idButtonChange");var s=this.getView().byId("idScheduleOrder");var k=this.getView().byId("idRemoveConstraints");D.setEnabled(false);i.setEnabled(false);j.setEnabled(false);s.setEnabled(false);k.setEnabled(false);},getShapeId:function(p,s,n){return p+""+s+""+n;},getStrokeFill:function(s,v){if(v==="X"){return"@sapNegativeColor";}else if(s==="X"){return"@sapTextColor";}else{return"@sapNeutralColor";}},getRelationToolTip:function(n,p,P,s,i,j){var k=this.getView().getModel("i18n").getResourceBundle();if(j==="X"){switch(n){case sap.gantt.simple.RelationshipType.StartToStart:return k.getText("violatedS2SRelTooltip",[p,P,s,i]);case sap.gantt.simple.RelationshipType.StartToFinish:return k.getText("violatedS2FRelTooltip",[p,P,s,i]);case sap.gantt.simple.RelationshipType.FinishToStart:return k.getText("violatedF2SRelTooltip",[p,P,s,i]);case sap.gantt.simple.RelationshipType.FinishToFinish:return k.getText("violatedF2FRelTooltip",[p,P,s,i]);default:return"";}}else{switch(n){case sap.gantt.simple.RelationshipType.StartToStart:return k.getText("normalS2SRelTooltip",[p,P,s,i]);case sap.gantt.simple.RelationshipType.StartToFinish:return k.getText("normalS2FRelTooltip",[p,P,s,i]);case sap.gantt.simple.RelationshipType.FinishToStart:return k.getText("normalF2SRelTooltip",[p,P,s,i]);case sap.gantt.simple.RelationshipType.FinishToFinish:return k.getText("normalF2FRelTooltip",[p,P,s,i]);default:return"";}}},_addPaddingAtStart:function(L,s){if(s.length===L){return s;}else{return this._addPaddingAtStart(L,"0"+s);}},_getInternalRelationshipType:function(s){switch(s){case"FinishToStart":return"NF";case"StartToStart":return"AF";case"FinishToFinish":return"EF";case"StartToFinish":return"SF";default:return" ";}},createRelationship:function(i){var p=sap.gantt.misc.Utility.parseUid;var m=this.getView().getModel();var s=i.getParameter("fromShapeUid");var P=p(s);var j=m.getObject(P.shapeDataName);var k=i.getParameter("toShapeUid");P=p(k);var n=m.getObject(P.shapeDataName);var v=i.getParameter("type");var w=this._getInternalRelationshipType(v);var x={"MaintenanceOrder":j.MaintenanceOrder,"MaintenanceOrderOperation":j.MaintenanceOrderOperation,"MaintenanceOrderSubOperation":"","MaintOrdOperationIsSuccessor":false,"RelatedMaintenanceOrder":n.MaintenanceOrder,"RelatedMaintOrderOperation":n.MaintenanceOrderOperation,"OrderOpRelationshipIntType":w};var y=this.getView().getModel("relationshipModel");var z=this;var D=z.getOwnerComponent().getModel("i18n").getResourceBundle();var H={success:function(K){var L={};L.itemHashMapContainer=[];L.itemHashMapContainer.push(j.MaintenanceOrder);L.itemHashMapContainer.push(n.MaintenanceOrder);L.parameters={};L.parameters.bRefreshOfSourceAppRequired=true;U.addMessage(D.getText("RelationshipCreationSuccess"),sap.ui.core.MessageType.Success,C.sDisplayTypeMessageToast);z.prepareTargetForRefreshGantt("","",L);},error:function(K){z.getView().byId("idOrderGanttContainer").setBusy(false);}};this.getView().byId("idOrderGanttContainer").setBusy(true);y.create("/C_RSHMaintenanceOrdOperationTP(MaintenanceOrder='"+this._addPaddingAtStart(12,j.MaintenanceOrder)+"',MaintenanceOrderOperation='"+j.MaintenanceOrderOperation+"',MaintenanceOrderSubOperation='"+encodeURIComponent(" ")+"')/to_MaintOrderOpRelationship",x,H);},onFirstVisibleRowChanged:function(i){this._refreshBinding(false);if(i.getSource().getBinding("rows")){if(this._sPerformanceFilterOnExpand){i.getSource().getBinding("rows").sFilterParams=this._sExistingFilterString;this._sPerformanceFilterOnExpand=null;}this.setFinalSelectForOrderRequest();}this._closeContextMenus();},onVisibleHorizonUpdate:function(){this._closeContextMenus();},_closeContextMenus:function(){if(this._oShapeContextMenu&&this._oShapeContextMenu.isOpen()){this._oShapeContextMenu.close();}if(this.oRelationshipActionSheet&&this.oRelationshipActionSheet.isPopoverOpen()){this.oRelationshipActionSheet.closePopover();}},_onGanttSettingDialogChange:function(L,s,i){var j=this._oOwnerComponent.getModel("UIModel");var p;Object.keys(i).forEach(function(v){if(v!=="enableNowLine"||v!=="enableCursorLine"||v!=="enableVerticalLine"||v!=="enableStatusBar"){p="/"+v;j.setProperty(p,i[v]);}});if(j.getProperty("/showUtilizationIndicator")||j.getProperty("/showNonWorkingTimes")){this._setThresholdForModelData();}this.updateRelationshipsAndUtilizations();this.bindCalendarDefHelper();var k=false;if(!(i.condensedModeActive===undefined)){this._activateCondensedMode(k);k=true;}if(i.enableNowLine!==undefined||i.enableCursorLine!==undefined||i.enableVerticalLine!==undefined||i.enableStatusBar!==undefined){var m=this.getView().byId("idOrderGanttContainer");var n={enableNowLine:i.enableNowLine!==undefined?i.enableNowLine:m.getEnableNowLine(),enableCursorLine:i.enableCursorLine!==undefined?i.enableCursorLine:m.getEnableCursorLine(),enableVerticalLine:i.enableVerticalLine!==undefined?i.enableVerticalLine:m.getEnableVerticalLine(),enableStatusBar:i.enableStatusBar!==undefined?i.enableStatusBar:m.getEnableStatusBar()};m.applySettings(n);k=false;}if(k){this.getView().byId("idOrderGanttContainer").rerender();}else{sap.ui.getCore().getEventBus().subscribeOnce(this.sOrderGanttChannel,this.sIndiviudalActionOnGanttChange,this.updateToolbarButtonsFromSelectedRows,this);}this.persistSettingsP13n();},onCustomGanttSettingPress:function(i){var v=this.getView();var j=sap.ui.getCore().getEventBus();var s=this.getOwnerComponent().getModel("GanttSettingConfiguration");var k=this._getGanttSettingValues();var m=new r(s.getData(),k,v);j.subscribeOnce(C.sLibraryChannel,C.sGanttSettingsChanged,this._onGanttSettingDialogChange,this);m.openDialog();},_getGanttSettingValues:function(){var s={};var i=this.getView().byId("idOrderGanttContainer");var j=this._oOwnerComponent.getModel("UIModel");s.enableNowLine=i.getEnableNowLine();s.enableCursorLine=i.getEnableCursorLine();s.enableVerticalLine=i.getEnableVerticalLine();s.enableStatusBar=i.getEnableStatusBar();s.bCondensedModeActive=j.getProperty("/condensedModeActive");s.bShowNonWorkingTimes=j.getProperty("/showNonWorkingTimes");s.bShowUtilizationIndicator=j.getProperty("/showUtilizationIndicator");s.bShowFinalDueDate=j.getProperty("/showFinalDueDate");s.bShowImpRel=j.getProperty("/showImpRel");s.bShowExpRel=j.getProperty("/showExpRel");s.bShowRestrictions=j.getProperty("/showRestrictions");return s;},_activateCondensedMode:function(i){var j=this._oOwnerComponent.getModel("UIModel");if(j.getProperty("/condensedModeActive")){this.getView().addStyleClass(this.getOwnerComponent().getContentDensityAdditionalClass());}else{this.getView().removeStyleClass(this.getOwnerComponent().getContentDensityAdditionalClass());}if(i){this.getView().byId("idOrderGanttContainer").rerender();}},updateRelationshipsAndUtilizations:function(){var i=this._oOwnerComponent.getModel("UIModel");var j=this.byId("OrderGntRowStgID");var k=this.byId("idOrderTreeTable");if(!i.getProperty("/showImpRel")&&!i.getProperty("/showExpRel")){if(j.getBindingInfo("relationships")){this._previousRelationshipBinding=j.getBindingInfo("relationships");j.unbindAggregation("relationships");k.setRowSettingsTemplate(null);k.setRowSettingsTemplate(j);}}else{if(!j.getBindingInfo("relationships")){var m=false;this._sPerformanceFilterOnExpand=null;this.setFinalSelectForOrderRequest(m);k.getBinding("rows").refresh();j.bindAggregation("relationships",this._previousRelationshipBinding);k.setRowSettingsTemplate(null);k.setRowSettingsTemplate(j);}}if(!i.getProperty("/showUtilizationIndicator")){if(j.getBindingInfo("shapes4")){this._previousUtilizationBinding=j.getBindingInfo("shapes4");j.unbindAggregation("shapes4");k.setRowSettingsTemplate(null);k.setRowSettingsTemplate(j);}}else{if(!j.getBindingInfo("shapes4")){m=false;this._sPerformanceFilterOnExpand=null;this.setFinalSelectForOrderRequest(m);k.getBinding("rows").refresh();j.bindAggregation("shapes4",this._previousUtilizationBinding);k.setRowSettingsTemplate(null);k.setRowSettingsTemplate(j);}}},persistSettingsP13n:function(){var i=this._oOwnerComponent.getModel("UIModel");var j=this.byId("idOrderGanttContainer");var s={};s.bShowImpRel=i.getProperty("/showImpRel");s.bShowExpRel=i.getProperty("/showExpRel");s.bShowNonWorkingTimes=i.getProperty("/showNonWorkingTimes");s.bShowCriticalPath=i.getProperty("/showCriticalPath");s.bCondensedModeActive=i.getProperty("/condensedModeActive");s.enableNowLine=j.getEnableNowLine();s.enableCursorLine=j.getEnableCursorLine();s.enableVerticalLine=j.getEnableVerticalLine();s.enableStatusBar=j.getEnableStatusBar();s.bShowFinalDueDate=i.getProperty("/showFinalDueDate");s.bShowRestrictions=i.getProperty("/showRestrictions");s.bShowUtilizationIndicator=i.getProperty("/showUtilizationIndicator");f.getInstance().getFeatureModel(C.sGanttP13nSettings).setProperty("/",s);f.getInstance().saveContainer();},_refreshBinding:function(i){var j=this.getView().byId("idOrderTreeTable");var k=j.getBinding("rows");if(k){if(k.aSorters&&k.aSorters.length>0){k.aSorters[0].sPath=this.sSortOrderField;k.aSorters[0].bDescending=this.sOrderSortOrder==="Descending"?true:false;}if(i){k.refresh(true);}}},_setCondensedMode:function(){var i=this._oOwnerComponent.getModel("UIModel");if(i.getProperty("/condensedModeActive")){this.getView().addStyleClass(this.getOwnerComponent().getContentDensityAdditionalClass());this.getView().byId("idOrderGanttContainer").rerender();}},_updateUiModelFromGanttSettings:function(i,s){if(s&&s.bShowImpRel!==null&&s.bShowImpRel!==undefined){i.setProperty("/showImpRel",s.bShowImpRel);i.setProperty("/showExpRel",s.bShowExpRel);i.setProperty("/showCriticalPath",false);i.setProperty("/showNonWorkingTimes",s.bShowNonWorkingTimes);i.setProperty("/condensedModeActive",s.bCondensedModeActive);i.setProperty("/showFinalDueDate",s.bShowFinalDueDate);i.setProperty("/showRestrictions",s.bShowRestrictions);i.setProperty("/showUtilizationIndicator",s.bShowUtilizationIndicator);}else{i.setProperty("/showImpRel",false);i.setProperty("/showExpRel",false);i.setProperty("/showCriticalPath",false);i.setProperty("/showNonWorkingTimes",false);i.setProperty("/condensedModeActive",false);i.setProperty("/showFinalDueDate",false);i.setProperty("/showRestrictions",false);i.setProperty("/showUtilizationIndicator",false);}},_setupSettings:function(){var i=this._oOwnerComponent.getModel("UIModel");var s=f.getInstance().getFeatureModel(C.sGanttP13nSettings).getProperty("/","oSettings");this._updateUiModelFromGanttSettings(i,s);if(s.enableNowLine!==undefined||s.enableCursorLine!==undefined||s.enableVerticalLine!==undefined){var j=this.getView().byId("idOrderGanttContainer");var m={enableNowLine:s.enableNowLine!==undefined?s.enableNowLine:j.getEnableNowLine(),enableCursorLine:s.enableCursorLine!==undefined?s.enableCursorLine:j.getEnableCursorLine(),enableVerticalLine:s.enableVerticalLine!==undefined?s.enableVerticalLine:j.getEnableVerticalLine(),enableStatusBar:s.enableStatusBar!==undefined?s.enableStatusBar:j.getEnableStatusBar()};j.applySettings(m);}},getRelVisibility:function(s,i,j){if(s==="X"){return j?1:0;}else{return i?1:0;}},_getCurrentAppState:function(){var s=this.byId("idOrderGanttSmartFilterBar");var i=this.getView().byId("idOrderGanttChartWithTable");var j={};this._oAppStateData.customData.selectionPanelSize=i.getSelectionPanelSize();j=this._oAppStateData.customData;var v=s.getVariantManagement();j.sCurrentVariantKey=v.getCurrentVariantId()===""?v.getStandardVariantKey():v.getCurrentVariantId();j.oFilterData=this._getCurrentFilterState(s,this._oStartDate,this._oEndDate);return j;},_getCurrentFilterState:function(s){var v=[];var H=[];s.getAllFilterItems(true).forEach(function(i){v.push(i.getName());if(i.getProperty("visibleInFilterBar")===false){H.push(i.getName());}});return{aFilters:s.getFilterData(),aVisibleFields:v,aHiddenFields:H};},_delayedTriggerSearch:function(){var s=this.getView().byId("idOrderGanttSmartFilterBar");if(s.isInitialised()&&this._bIsAppStateApplied&&!s.isCurrentVariantExecuteOnSelectEnabled()){var p={finalTrigger:true};s.fireSearch(p);}this._bFirstTriggerDone=true;},_submitDelayedRequests:function(){this.getView().getModel().attachBatchRequestCompleted(this._requestComplete,this);this.getView().getModel().submitChanges({groupId:"iDBatchOrderFilterRequest"});var i=this.getView().getModel().getDeferredBatchGroups();var j=i.indexOf("iDBatchOrderFilterRequest");i.splice(j,1);this.getView().getModel().setDeferredGroups(i);this._bSubmitofDeferredRequestsDone=true;},setAppState:function(s){var i=this.byId("idOrderGanttSmartFilterBar");if(s&&s.customData&&Object.keys(s.customData).length!==0){var v=i.getVariantManagement().getVariantContent(i,s.customData.sCurrentVariantKey);if(this._isIAppState&&s.customData.oFilterData){if(v){i.setCurrentVariantId(s.customData.sCurrentVariantKey);}if(s.customData.oFilterData.aVisibleFields){s.customData.oFilterData.aVisibleFields.forEach(function(k){if(k){i.addFieldToAdvancedArea(k);}});if(i.getControlConfiguration().length!==s.customData.oFilterData.aVisibleFields.length){i._oVariantManagement.currentVariantSetModified(true);}}if(s.customData.oFilterData.aHiddenFields){s.customData.oFilterData.aHiddenFields.forEach(function(k){if(k){var j=i._getFilterItemByName(k);j.setVisibleInAdvancedArea(false);}});}i.setFilterData(s.customData.oFilterData.aFilters,true);}if(s.customData.aSortColumn&&s.customData.aSortColumn.hasOwnProperty("id")){if(this.getView().byId(s.customData.aSortColumn.id)){this.onSortRequest("",s.customData.aSortColumn);}}}},getOnCriticalVisibility:function(i,s){if(i==="X"&&s){return true;}else{return false;}},_onPersChangeForColumns:function(i){var j=this.getView().byId("idOrderTreeTable");var k=this.getView().byId("idOrderGanttChartWithTable");this._oAppStateData={customData:G.getGanttColumnPersonalization(j,k,i,this._oAppStateData)};},getFFDMilestoneTitle:function(i){var s="";if(i){var j=sap.ui.core.format.DateFormat.getDateInstance().format(i,true);s=this.getView().getModel("i18n").getResourceBundle().getText("FinalDueDateTooltip",[j]);}return s;},MoveOperationBasedOnDateChange:function(i){var j=sap.ui.getCore().getEventBus();j.subscribeOnce(C.sLibraryChannel,C.sServerMessageToUpdateEntity,this.prepareTargetForRefreshGantt,this);var m=this.getView().getModel();var s=i.getParameter("cursorDateTime");var k=new Date();if(s<k){U.addMessage(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ErrorMessageDragAndDroptoPastDates"),sap.ui.core.MessageType.Error,C.sDisplayTypeMessageBox);}else{var n=U.getAdjustedDate(s);var p=i.getParameter("targetRow");var v=i.getParameter("targetShape");var w;this.getView().byId("idOrderGanttContainer").setBusy(true);if(p&&p.getBindingContext()){w=m.getObject(p.getBindingContext().getPath());}else if(v&&v.getParent()&&v.getParent().getBindingContext()){w=m.getObject(v.getParent().getBindingContext().getPath());}var x=sap.ui.core.format.DateFormat.getDateInstance({pattern:"PTHH'H'mm'M'ss'S'"});var y=U.roundDateToNearestDnDGranularity(s);var z=x.format(y);this._itemHashMap=new I();this._oChangeOperationsDelegate=new c();this._oChangeOperationsDelegate.scheduleOperationBasedOnDateChange(n,z,w,m,this._itemHashMap);var D="massChange";this._itemHashMap.triggerBackendCall(D,C.sAfterDragAndDropFinalizedGanttApp);}},bindCalendarDefHelper:function(){var i=this._getCurrentTimePeriod();var j=encodeURIComponent(i.sCalendarStartDate.toISOString().substring(0,19));var k=encodeURIComponent(i.sCalendarEndDate.toISOString().substring(0,19));var m=this._oOwnerComponent.getModel("UIModel");if(m.getProperty("/showNonWorkingTimes")){if(this.oFromDate===j&&this.oToDate===k&&this.byId("idCalDef").getDefs().length){return;}this.oFromDate=j;this.oToDate=k;this.byId("idCalDef").bindAggregation("defs",{path:"/C_RSHOrderGanttCalendar(P_StartDate=datetime'"+j+"',P_EndDate=datetime'"+k+"')/Set",parameters:{expand:"to_Intervals",groupId:"GetCalendars"},template:new g({key:"{WorkCenterInternalID}",backgroundColor:"sapShell_Background",timeIntervals:{path:"to_Intervals",templateShareable:true,template:new T({startTime:{path:"WorkCenterNonAvailStrtDteTme",formatter:this.removeTimeZoneOffset},endTime:{path:"WorkCenterNonAvailEndDteTme",formatter:this.removeTimeZoneOffset}})}})});}else if(!m.getProperty("/showNonWorkingTimes")){this.byId("idCalDef").unbindDefs();}},_getCorrespondingChangedOperations:function(j,s){var k=[];for(var i=0;i<j.length;i++){if(j[i].Order===s){k.push(j[i].Operation);}}return k;},_getDataFromModel:function(m,p,P){return m.getProperty(p+"/"+P);},_createAdditionalOrderOpFilterForUtilizationUpdate:function(m,k,w,n){var p=[],s={};for(var i=0;w.length&&i<n.length;i++){var v=k.oKeys[n[i].substring(1)];for(var j=0;w.length&&j<v.length;j++){var x=this._getDataFromModel(m,"/"+v[j],"MainWorkCenter");var y=w.indexOf(x);if(y!==-1){w.splice(y,1);s=new o({filters:[new o("MaintenanceOrder",q.EQ,this._getDataFromModel(m,"/"+v[j],"MaintenanceOrder")),new o("MaintenanceOrderOperation",q.EQ,this._getDataFromModel(m,"/"+v[j],"MaintenanceOrderOperation"))],and:true});p.push(new o(s,false));}}}return p;},_findOperationsForUtilizationUpdate:function(k){var m=this.byId("idOrderTreeTable").getBinding("rows"),n=m.getRootContexts(),p=[],s=[],i,j;for(i=0;i<k.length;i++){for(j=0;j<n.length;j++){var P=n[j].sPath;if(!m.oKeys[P.substring(1)]){continue;}if(i===0){p.push(P);}if(P.indexOf(k[i].Order)!==-1){var v=p.indexOf(P);if(v!==-1){p.splice(v,1);}s.push(P);}}}var w=[],x=[],M=m.getModel();for(i=0;i<s.length;i++){var y=m.oKeys[s[i].substring(1)];var z=this._getDataFromModel(M,s[i],"MaintenanceOrder");var D=this._getCorrespondingChangedOperations(k,z);for(j=0;j<y.length;j++){var W=this._getDataFromModel(M,"/"+y[j],"MainWorkCenter");if(D.indexOf(this._getDataFromModel(M,"/"+y[j],"MaintenanceOrderOperation"))!==-1){if(x.indexOf(W)===-1){x.push(W);}}else{if(w.indexOf(W)===-1){w.push(W);}}}}var H=[],K=[];for(i=0;i<x.length;i++){if(w.indexOf(x[i])===-1){H.push(x[i]);}}if(H.length){K=this._createAdditionalOrderOpFilterForUtilizationUpdate(M,m,H,p);}return K;},prepareTargetForRefreshGantt:function(s,i,j){var m=this.byId("idOrderTreeTable").getModel();var p="/C_RSHOrdersAndOperations";var k=this.getModel("UIModel");var n={};var v=[],w,x=[],y=[],z=[];var D=j.itemHashMapContainer;if(!j.parameters.bRefreshOfSourceAppRequired){this._onAfterActionsCompleted(j.parameters);return;}var N=0;var H=[];if(s!==""&&i!==C.sOnRelationshipDelete){for(var K in D){if(D.hasOwnProperty(K)){var L=K.split(",");if(N===0){N=(L[2]===C.workcenterAction||L[2]===C.reassignWorkCenterAction||L[2]===C.schedulingOperationAction||L[2]===C.removeConstraintsAction)?1:0;}if(L[2]===C.workcenterAction){var M={Order:L[0],Operation:L[1]};H.push(M);}w=new o({filters:[new o("MaintenanceOrder",q.EQ,L[0]),new o("MaintenanceOrderOperation",q.EQ,L[1])],and:true});x.push(new o(w,false));if(!y.includes(L[0])){y.push(L[0]);z.push(new o("MaintenanceOrder",q.EQ,L[0]));}}}}else{D.forEach(function(Y){N=1;if(y.indexOf(Y)===-1){y.push(Y);z.push(new o("MaintenanceOrder",q.EQ,Y));}});}if(H.length&&k.getProperty("/showUtilizationIndicator")){var P=this._findOperationsForUtilizationUpdate(H);}var Q=z.slice();v=this._adjustFiltersForOpQuery(N,Q,P,x,k.getProperty("/showUtilizationIndicator"));var _=this._sOperationAppStateFields?this._sOperationAllTechMandatoryFields+this._sOperationAppStateFields:this._sOperationAllTechMandatoryFields;n=this._getUrlParametersForDeltaRefresh(k.getProperty("/showImpRel"),k.getProperty("/showExpRel"),k.getProperty("/showUtilizationIndicator"),_);var V=this._performDeltaReadQuery(m,p,v,n);v=[];v.push(new o(z,false));v.push(new o({filters:[new o("OrderOperationRowLevel",q.EQ,0)],and:true}));var W=this._sOrderAppStateFields?this._sOrderAllTechMandatoryFields+","+this._sOrderAppStateFields:this._sOrderAllTechMandatoryFields;n=this._getUrlParametersForDeltaRefresh(k.getProperty("/showImpRel"),k.getProperty("/showExpRel"),false,W);var X=this._performDeltaReadQuery(m,p,v,n);Promise.all([V,X]).then(this._onAfterActionsCompleted(j.parameters));},_adjustFiltersForOpQuery:function(n,i,j,k,s){var m=[];if(n===1){if(j&&j.length){m.push(new o(i,false));m[0].aFilters.push(new o(j,false));}else{m.push(new o(i,false));}if(U.isMockRun()){m.push(new o("OrderOperationRowLevel",q.EQ,1));}}else{m.push(new o(k,false));}if(s){var p=this._getCurrentTimePeriod();var D=new o({filters:[new o("StartDate",q.EQ,p.sCalendarStartDate),new o("EndDate",q.EQ,p.sCalendarEndDate)],and:true});m[0].aFilters.push(new o(D,false));}return m;},_performDeltaReadQuery:function(m,p,i,j){return new Promise(function(k,n){m.read(p,{filters:i,urlParameters:j,success:function(D){k();},error:function(){k();}});});},_getUrlParametersForDeltaRefresh:function(s,i,j,k){var m="",n=k;var p={};if(s||i){m="to_Relationships";n=n+","+"to_Relationships";}if(j){m=m?m+","+"to_UtilIndicator":"to_UtilIndicator";n=n+","+"to_UtilIndicator";}if(m){p={"$expand":m,"$select":n};}else{p={"$select":n};}return p;},initSortOrderAndSortOperationFields:function(){this.sSortOrderField="MaintenanceOrder";this.sSortOperationField="MaintenanceOrderOperation";this.sOrderSortOrder="Ascending";this.sOperationSortOrder=null;},onPrint:function(){var i=this;var j=new l({ganttChart:i.getView().byId("idOrderGanttChartWithTable")});j.open();},onShapeContextMenu:function(i){var s=i.getParameter("shape");var v=this.getView();if(s instanceof R){var p=s.getBindingContext().getPath();var D=s.getModel().getData(p);if(D.RelationshipIsExplicit==="X"){s.setSelectedStroke("@sapUiInformative");var j=sap.ui.getCore().getEventBus();j.subscribe(C.sLibraryChannel,C.sRelationshipDeleteInGantt,this.onDeleteRelationship,this);j.subscribeOnce(C.sLibraryChannel,C.sRelationshipDeleteContextMenuClose,this.onDeleteRelationshipContextMenuClose,this);if(!this.oRelationshipActionSheet){this.oRelationshipActionSheet=new t();}this.oRelationshipActionSheet.onOpen(i,v,s);}}else if(s.getMetadata().getName()==="sap.gantt.simple.BaseGroup"){this._oShapeForOpContextMenu=s;var _=i.getParameter("pageX");var k=i.getParameter("pageY");var m=s.getBindingContext().getPath();var n=this.getModel().getData(m);if(n.ProcessingStatusText==="In Process"){var w=this.getView().getModel("i18n").getResourceBundle();U.addMessage(w.getText("InfoMessageOperationInProcessStatus"),sap.ui.core.MessageType.Information,C.sDisplayTypeMessageToast);}else{if(!this._oShapeContextMenu){u.load({id:v.getId(),name:"rsh.eam.ordergantts1.view.OperationActionSheet",type:"XML",controller:this}).then(function(x){this._oShapeContextMenu=x;v.addDependent(x);this._setupOperationShapeContextMenu(n.ProcessingStatusText,n.OpBscStartDateConstraintType);this.openOperationShapeContextMenu(_,k);}.bind(this));}else{this._setupOperationShapeContextMenu(n.ProcessingStatusText,n.OpBscStartDateConstraintType);this.openOperationShapeContextMenu(_,k);}}}},onDeleteRelationship:function(s,i,j){this.getView().byId("idOrderGanttContainer").setBusy(true);var m=this.getView().getModel("relationshipModel");var p=j.getBindingContext().getPath();var k=j.getModel().getData(p);var n=k.PredecessorOrderOperation;var v=k.SuccessorOrderOperation;var w=k.PredecessorOrder;var x=k.SuccessorOrder;var y=j.getProperty("type");var z=this._getInternalRelationshipType(y);var D=sap.ui.getCore().getLibraryResourceBundle("sap.rsh.eam.lib.common");var H=this;m.remove("/C_RSHMaintenanceOrdOpRelshpTP(MaintenanceOrder='"+this._addPaddingAtStart(12,k.PredecessorOrder)+"',MaintenanceOrderOperation='"+n+"',MaintenanceOrderSubOperation='"+encodeURIComponent(" ")+"',MaintOrdOperationIsSuccessor="+false+",RelatedMaintenanceOrder='"+this._addPaddingAtStart(12,k.SuccessorOrder)+"',RelatedMaintOrderOperation='"+v+"',OrderOpRelationshipIntType='"+z+"')",{success:function(K){var L={};L.itemHashMapContainer=[];L.itemHashMapContainer.push(w);L.itemHashMapContainer.push(x);L.parameters={};L.parameters.bRefreshOfSourceAppRequired=true;U.addMessage(D.getText("RelationshipDeletionSuccess"),sap.ui.core.MessageType.Success,C.sDisplayTypeMessageToast);H.prepareTargetForRefreshGantt("","",L);},error:function(K){U.addMessage(D.getText("RelationshipDeletionError"),sap.ui.core.MessageType.Success,C.sDisplayTypeMessageToast);H.getView().byId("idOrderGanttContainer").setBusy(false);}});},onDeleteRelationshipContextMenuClose:function(s,i,j){var k=sap.ui.getCore().getEventBus();k.unsubscribe(C.sLibraryChannel,C.sRelationshipDeleteInGantt,this.onDeleteRelationship,this);if(j){j.setSelectedStroke(null);j.setSelected(false);}},openOperationShapeContextMenu:function(p,P){var i=new sap.m.Label();var j=new sap.ui.core.Popup(i,false,true,false);var k=sap.ui.core.Popup.Dock;var s=(p+1)+" "+(P-15);j.open(0,k.BeginTop,k.LeftTop,null,s);this._oShapeContextMenu.openBy(i);},_setupOperationShapeContextMenu:function(s,i){if(s==="Due"){this.byId("idButtonChangeAction").setProperty("visible",true);this.byId("idButtonDispatchAction").setProperty("visible",true);this.byId("idButtonCancDispatchAction").setProperty("visible",false);}else if(s==="Dispatched"){this.byId("idButtonChangeAction").setProperty("visible",true);this.byId("idButtonDispatchAction").setProperty("visible",false);this.byId("idButtonCancDispatchAction").setProperty("visible",true);}if(i==="1"){this.byId("idButtonRemoveConstraintsAction").setProperty("visible",true);}else{this.byId("idButtonRemoveConstraintsAction").setProperty("visible",false);}},onExit:function(){this._oInnerAppState={customData:this._getCurrentAppState()};f.getInstance().getFeatureModel(C.sGanttAppState).setProperty("/",this._oInnerAppState);f.getInstance().saveContainer();}});});
